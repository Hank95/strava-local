{% extends "base.html" %}

{% block title %}Settings - Strava Local{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Settings</h1>
    <p class="page-subtitle">Configure your athlete profile and training zones</p>
</div>

{% if request.query_params.get('saved') %}
<div class="alert alert--success animate-fade-in">
    Profile saved successfully.
</div>
{% endif %}

{% if request.query_params.get('recomputed') %}
<div class="alert alert--success animate-fade-in">
    Metrics recomputed for {{ request.query_params.get('count') }} activities.
</div>
{% endif %}

{% if request.query_params.get('strava_saved') %}
<div class="alert alert--success animate-fade-in">
    Strava API credentials saved.
</div>
{% endif %}

{% if request.query_params.get('strava_connected') %}
<div class="alert alert--success animate-fade-in">
    Successfully connected to Strava! You can now sync your activities.
</div>
{% endif %}

{% if request.query_params.get('strava_synced') %}
<div class="alert alert--success animate-fade-in">
    Strava sync complete: {{ request.query_params.get('new') }} new, {{ request.query_params.get('updated') }} updated.
</div>
{% endif %}

{% if request.query_params.get('strava_disconnected') %}
<div class="alert alert--success animate-fade-in">
    Strava has been disconnected.
</div>
{% endif %}

{% if request.query_params.get('strava_error') %}
<div class="alert alert--error animate-fade-in">
    {% set error = request.query_params.get('strava_error') %}
    {% if error == 'no_credentials' %}
        Please enter your Strava API credentials first.
    {% elif error == 'no_code' %}
        Authorization failed - no code received from Strava.
    {% elif error == 'token_exchange_failed' %}
        Failed to connect to Strava. Please check your credentials.
    {% elif error == 'not_connected' %}
        Please connect to Strava first.
    {% elif error == 'sync_failed' %}
        Sync failed. Please try again or reconnect.
    {% else %}
        Strava error: {{ error }}
    {% endif %}
</div>
{% endif %}

<form action="/settings/profile" method="post">
    <div class="chart-card animate-slide-up">
        <div class="chart-card__header">
            <h3>Athlete Profile</h3>
        </div>

        <p class="text-muted mb-lg">
            Enter your physiological parameters for accurate TSS and HR zone calculations.
            Leave fields blank to use auto-estimated values from your activity data.
        </p>

        <div class="settings-grid">
            <div class="form-group">
                <label class="form-group__label" for="max_hr">Maximum Heart Rate</label>
                <input type="number" id="max_hr" name="max_hr" class="form-group__input"
                       value="{{ profile.max_hr or '' }}"
                       placeholder="{{ effective.max_hr or 'Unknown' }}"
                       min="100" max="250">
                <small class="form-group__help">
                    {% if effective.max_hr and not profile.max_hr %}
                    Estimated: <span class="text-primary">{{ effective.max_hr }} bpm</span>
                    {% else %}
                    Your maximum heart rate in bpm
                    {% endif %}
                </small>
            </div>

            <div class="form-group">
                <label class="form-group__label" for="lthr">Lactate Threshold HR (LTHR)</label>
                <input type="number" id="lthr" name="lthr" class="form-group__input"
                       value="{{ profile.lthr or '' }}"
                       placeholder="{{ effective.lthr or 'Unknown' }}"
                       min="80" max="220">
                <small class="form-group__help">
                    {% if effective.lthr and not profile.lthr %}
                    Estimated: <span class="text-primary">{{ effective.lthr }} bpm</span> (89% of max)
                    {% else %}
                    HR you can sustain for ~1 hour
                    {% endif %}
                </small>
            </div>

            <div class="form-group">
                <label class="form-group__label" for="resting_hr">Resting Heart Rate</label>
                <input type="number" id="resting_hr" name="resting_hr" class="form-group__input"
                       value="{{ profile.resting_hr or '' }}"
                       placeholder="60"
                       min="30" max="100">
                <small class="form-group__help">Morning resting HR (defaults to 60)</small>
            </div>

            <div class="form-group">
                <label class="form-group__label" for="ftp">FTP (Functional Threshold Power)</label>
                <input type="number" id="ftp" name="ftp" class="form-group__input"
                       value="{{ profile.ftp or '' }}"
                       placeholder="Not set"
                       min="50" max="500">
                <small class="form-group__help">For power-based TSS (cycling)</small>
            </div>

            <div class="form-group">
                <label class="form-group__label" for="weight_kg">Body Weight</label>
                <input type="number" id="weight_kg" name="weight_kg" class="form-group__input"
                       value="{{ profile.weight_kg or '' }}"
                       placeholder="Not set"
                       min="30" max="200" step="0.1">
                <small class="form-group__help">Weight in kg (for power/weight metrics)</small>
            </div>
        </div>

        {% if effective.hr_zones %}
        <div class="zone-preview">
            <h4>HR Zones (based on LTHR: {{ effective.lthr }} bpm)</h4>
            <div class="zone-bar">
                <div class="zone-bar__segment zone-bar__segment--z1">Z1</div>
                <div class="zone-bar__segment zone-bar__segment--z2">Z2</div>
                <div class="zone-bar__segment zone-bar__segment--z3">Z3</div>
                <div class="zone-bar__segment zone-bar__segment--z4">Z4</div>
                <div class="zone-bar__segment zone-bar__segment--z5">Z5</div>
            </div>
            <div class="zone-labels">
                <span>&lt;{{ effective.hr_zones.z1_max }}</span>
                <span>{{ effective.hr_zones.z1_max }}-{{ effective.hr_zones.z2_max }}</span>
                <span>{{ effective.hr_zones.z2_max }}-{{ effective.hr_zones.z3_max }}</span>
                <span>{{ effective.hr_zones.z3_max }}-{{ effective.hr_zones.z4_max }}</span>
                <span>&gt;{{ effective.hr_zones.z4_max }}</span>
            </div>
        </div>
        {% endif %}

        <div class="mt-lg">
            <button type="submit" class="btn btn--primary">Save Profile</button>
        </div>
    </div>
</form>

<div class="chart-card animate-slide-up">
    <div class="chart-card__header">
        <h3>Strava API Integration</h3>
        {% if strava_connected %}
        <span class="badge badge--success">Connected</span>
        {% endif %}
    </div>

    <p class="text-muted mb-lg">
        Connect to the Strava API to automatically sync new activities. This keeps your local database
        up-to-date without re-exporting your data.
    </p>

    {% if not strava_connected %}
    <div class="strava-setup">
        <h4 class="font-semibold mb-md">Step 1: Create a Strava API Application</h4>
        <ol class="text-muted mb-lg">
            <li>Go to <a href="https://www.strava.com/settings/api" target="_blank" class="text-primary">Strava API Settings</a></li>
            <li>Create a new application (use any name/website)</li>
            <li>Set the <strong>Authorization Callback Domain</strong> to: <code>localhost</code></li>
            <li>Copy your <strong>Client ID</strong> and <strong>Client Secret</strong> below</li>
        </ol>

        <h4 class="font-semibold mb-md">Step 2: Enter API Credentials</h4>
        <form action="/settings/strava" method="post">
            <div class="settings-grid">
                <div class="form-group">
                    <label class="form-group__label" for="strava_client_id">Client ID</label>
                    <input type="text" id="strava_client_id" name="strava_client_id" class="form-group__input"
                           value="{{ profile.strava_client_id or '' }}"
                           placeholder="e.g., 12345">
                </div>
                <div class="form-group">
                    <label class="form-group__label" for="strava_client_secret">Client Secret</label>
                    <input type="password" id="strava_client_secret" name="strava_client_secret" class="form-group__input"
                           value="{{ profile.strava_client_secret or '' }}"
                           placeholder="Your secret key">
                </div>
            </div>
            <button type="submit" class="btn btn--secondary">Save Credentials</button>
        </form>

        {% if profile.strava_client_id and profile.strava_client_secret %}
        <div class="mt-lg">
            <h4 class="font-semibold mb-md">Step 3: Authorize with Strava</h4>
            <p class="text-muted mb-md">Click below to authorize Strava Local to access your activities.</p>
            <a href="/settings/strava/connect" class="btn btn--primary">
                Connect to Strava
            </a>
        </div>
        {% endif %}
    </div>
    {% else %}
    <div class="strava-connected">
        <div class="strava-status mb-lg">
            <div class="strava-status__icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
            </div>
            <div class="strava-status__text">
                <strong>Connected to Strava</strong>
                {% if profile.strava_athlete_id %}
                <span class="text-muted"> (Athlete ID: {{ profile.strava_athlete_id }})</span>
                {% endif %}
                {% if profile.strava_last_sync %}
                <br><small class="text-muted">Last sync: {{ profile.strava_last_sync.strftime('%Y-%m-%d %H:%M') }}</small>
                {% endif %}
            </div>
        </div>

        <div class="strava-actions">
            <form action="/settings/strava/sync" method="post" style="display: inline;">
                <button type="submit" class="btn btn--primary">
                    Sync New Activities
                </button>
            </form>
            <form action="/settings/strava/disconnect" method="post" style="display: inline; margin-left: var(--space-sm);">
                <button type="submit" class="btn btn--secondary btn--danger">
                    Disconnect
                </button>
            </form>
        </div>

        <p class="text-muted mt-md" style="font-size: var(--font-size-sm);">
            Syncing fetches activities since your last sync. Only new activities are added; existing ones are updated.
        </p>
    </div>
    {% endif %}
</div>

<div class="chart-card animate-slide-up">
    <div class="chart-card__header">
        <h3>About Training Metrics</h3>
    </div>

    <h4 class="font-semibold">Training Stress Score (TSS)</h4>
    <p class="text-muted mb-md">TSS quantifies training load. A score of 100 equals one hour at your lactate threshold. TSS is calculated using:</p>
    <ul class="text-muted mb-lg">
        <li><strong>HR-based</strong>: Uses TRIMP formula with your HR stream data (most accurate)</li>
        <li><strong>Duration-based</strong>: Estimates from activity type and duration (fallback)</li>
    </ul>

    <h4 class="font-semibold">Training Load Metrics</h4>
    <ul class="text-muted mb-lg">
        <li><strong>CTL (Chronic Training Load)</strong>: 42-day rolling average of TSS - represents your "fitness"</li>
        <li><strong>ATL (Acute Training Load)</strong>: 7-day rolling average of TSS - represents "fatigue"</li>
        <li><strong>TSB (Training Stress Balance)</strong>: CTL - ATL - represents "form"
            <ul>
                <li>Positive TSB: Fresh and ready to perform</li>
                <li>Negative TSB: Fatigued, need recovery</li>
            </ul>
        </li>
    </ul>

    <h4 class="font-semibold">HR Zones (Friel Method)</h4>
    <ul class="text-muted">
        <li><strong>Z1 Recovery</strong>: &lt;68% LTHR</li>
        <li><strong>Z2 Aerobic</strong>: 68-83% LTHR</li>
        <li><strong>Z3 Tempo</strong>: 83-94% LTHR</li>
        <li><strong>Z4 Threshold</strong>: 94-105% LTHR</li>
        <li><strong>Z5 VO2max</strong>: &gt;105% LTHR</li>
    </ul>
</div>

<div class="danger-zone animate-slide-up">
    <h4>Recompute Metrics</h4>
    <p class="text-muted mb-md">After changing your profile, recompute all metrics to apply the new values:</p>
    <form action="/settings/recompute" method="post">
        <button type="submit" class="btn btn--secondary">
            Recompute All Metrics
        </button>
        <small class="text-muted mt-sm" style="display: block;">
            This may take a while for large datasets.
        </small>
    </form>
</div>
{% endblock %}
