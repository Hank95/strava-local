{% extends "base.html" %}

{% block title %}Maps - Strava Local{% endblock %}

{% block head %}
<style>
    /* Wrapper for positioning */
    .map-wrapper {
        position: relative;
        width: 100%;
        height: calc(100vh - 180px);
        min-height: 500px;
    }

    /* Map container with clipped corners */
    .map-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border-radius: 12px;
        background: #e9ecef;
        overflow: hidden;
    }

    .map-container iframe {
        width: 100%;
        height: 100%;
        border: none;
    }

    /* Floating control panel (positioned relative to wrapper, not container) */
    .map-controls {
        position: absolute;
        top: 16px;
        left: 16px;
        z-index: 1001;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        min-width: 280px;
        max-width: 320px;
    }

    .map-controls.collapsed {
        min-width: auto;
        padding: 8px 12px;
    }

    .map-controls.collapsed .controls-body {
        display: none;
    }

    .controls-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        gap: 8px;
    }

    .map-controls.collapsed .controls-header {
        margin-bottom: 0;
    }

    .controls-header h3 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
    }

    .toggle-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        color: var(--muted-color);
        font-size: 1.2rem;
    }

    .controls-body label {
        display: block;
        margin-bottom: 12px;
        font-size: 0.85rem;
    }

    .controls-body select,
    .controls-body input {
        margin-top: 4px;
        font-size: 0.9rem;
        padding: 8px 10px;
    }

    .controls-body .btn-row {
        display: flex;
        gap: 8px;
        margin-top: 16px;
    }

    .controls-body button {
        flex: 1;
        padding: 10px 16px;
        font-size: 0.85rem;
        margin: 0;
    }

    .btn-secondary {
        background: var(--secondary);
        border-color: var(--secondary);
    }

    /* Map type toggle */
    .map-type-toggle {
        display: flex;
        background: #f1f3f4;
        border-radius: 8px;
        padding: 4px;
        margin-bottom: 16px;
    }

    .map-type-toggle button {
        flex: 1;
        padding: 8px 12px;
        border: none;
        background: transparent;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--muted-color);
        margin: 0;
    }

    .map-type-toggle button.active {
        background: white;
        color: var(--color);
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* Loading overlay */
    .map-loading {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999;
    }

    .map-loading.hidden {
        display: none;
    }

    .loading-spinner {
        text-align: center;
    }

    .loading-spinner::before {
        content: "";
        display: block;
        width: 40px;
        height: 40px;
        margin: 0 auto 12px;
        border: 3px solid #e9ecef;
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Location status */
    .location-status {
        font-size: 0.75rem;
        color: var(--muted-color);
        margin-top: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .location-status.success { color: #2e7d32; }
    .location-status.error { color: #c62828; }

    /* Filters summary when collapsed */
    .filters-summary {
        font-size: 0.75rem;
        color: var(--muted-color);
        display: none;
    }

    .map-controls.collapsed .filters-summary {
        display: block;
        margin-top: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="map-wrapper">
    <!-- Floating Controls (outside container to avoid clipping) -->
    <div id="map-controls" class="map-controls">
        <div class="controls-header">
            <h3>Explore</h3>
            <button class="toggle-btn" onclick="toggleControls()" title="Collapse">−</button>
        </div>
        <div class="filters-summary" id="filters-summary"></div>
        <div class="controls-body">
            <!-- Map Type Toggle -->
            <div class="map-type-toggle">
                <button id="btn-heatmap" class="active" onclick="setMapType('heatmap')">Heatmap</button>
                <button id="btn-routes" onclick="setMapType('routes')">Routes</button>
            </div>

            <label>
                Activity Type
                <select id="filter-type">
                    <option value="">All activities</option>
                    {% for t in activity_types %}
                    <option value="{{ t }}">{{ t }}</option>
                    {% endfor %}
                </select>
            </label>

            <label>
                Date Range
                <div style="display: flex; gap: 8px; margin-top: 4px;">
                    <input type="date" id="filter-after" placeholder="From" style="flex: 1;">
                    <input type="date" id="filter-before" placeholder="To" style="flex: 1;">
                </div>
            </label>

            <label>
                Max Activities
                <input type="number" id="filter-limit" value="200" min="10" max="500">
                <small style="color: var(--muted-color); font-size: 0.7rem;">Higher = slower loading</small>
            </label>

            <div class="btn-row">
                <button onclick="updateMap()">Apply</button>
                <button class="btn-secondary outline" onclick="resetFilters()">Reset</button>
            </div>

            <div id="location-status" class="location-status"></div>
        </div>
    </div>

    <div class="map-container">
        <!-- Loading Overlay -->
        <div id="map-loading" class="map-loading hidden">
            <div class="loading-spinner">
                <span>Loading map...</span>
            </div>
        </div>

        <!-- Map Frame -->
        <iframe id="map-frame" src="about:blank"></iframe>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentMapType = 'heatmap';
let userLat = null;
let userLon = null;
let controlsCollapsed = false;

// Get user location on page load
function getUserLocation() {
    const status = document.getElementById('location-status');

    if (!navigator.geolocation) {
        status.textContent = 'Geolocation not supported';
        status.className = 'location-status error';
        loadMap();
        return;
    }

    status.innerHTML = '<span aria-busy="true"></span> Getting your location...';
    status.className = 'location-status';

    navigator.geolocation.getCurrentPosition(
        (position) => {
            userLat = position.coords.latitude;
            userLon = position.coords.longitude;
            status.textContent = '✓ Centered on your location';
            status.className = 'location-status success';
            loadMap();
        },
        (error) => {
            status.textContent = 'Using default location';
            status.className = 'location-status';
            loadMap();
        },
        { timeout: 5000, enableHighAccuracy: false }
    );
}

function loadMap() {
    updateMap();
}

function setMapType(type) {
    currentMapType = type;
    document.getElementById('btn-heatmap').classList.toggle('active', type === 'heatmap');
    document.getElementById('btn-routes').classList.toggle('active', type === 'routes');
    updateMap();
}

function updateMap() {
    const type = document.getElementById('filter-type').value;
    const after = document.getElementById('filter-after').value;
    const before = document.getElementById('filter-before').value;
    const limit = document.getElementById('filter-limit').value;

    const params = [];
    if (type) params.push(`type=${encodeURIComponent(type)}`);
    if (after) params.push(`after=${after}`);
    if (before) params.push(`before=${before}`);
    if (limit) params.push(`limit=${limit}`);
    if (userLat && userLon) {
        params.push(`lat=${userLat}`);
        params.push(`lon=${userLon}`);
    }

    const url = `/maps/embed/${currentMapType}?${params.join('&')}`;

    const frame = document.getElementById('map-frame');
    const loading = document.getElementById('map-loading');

    loading.classList.remove('hidden');

    frame.onload = function() {
        loading.classList.add('hidden');
    };

    frame.src = url;
    updateFiltersSummary();
}

function resetFilters() {
    document.getElementById('filter-type').value = '';
    document.getElementById('filter-after').value = '';
    document.getElementById('filter-before').value = '';
    document.getElementById('filter-limit').value = '200';
    updateMap();
}

function toggleControls() {
    const controls = document.getElementById('map-controls');
    const btn = controls.querySelector('.toggle-btn');
    controlsCollapsed = !controlsCollapsed;
    controls.classList.toggle('collapsed', controlsCollapsed);
    btn.textContent = controlsCollapsed ? '+' : '−';
    btn.title = controlsCollapsed ? 'Expand' : 'Collapse';
}

function updateFiltersSummary() {
    const type = document.getElementById('filter-type').value;
    const after = document.getElementById('filter-after').value;
    const before = document.getElementById('filter-before').value;

    const parts = [currentMapType === 'heatmap' ? 'Heatmap' : 'Routes'];
    if (type) parts.push(type);
    if (after || before) {
        const dateRange = [after || '...', before || '...'].join(' to ');
        parts.push(dateRange);
    }

    document.getElementById('filters-summary').textContent = parts.join(' • ');
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    getUserLocation();
});
</script>
{% endblock %}
