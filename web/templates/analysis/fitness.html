{% extends "base.html" %}

{% block title %}Fitness - Strava Local{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Fitness</h1>
    <p class="page-subtitle">Training load analysis and performance tracking</p>
</div>

{% if form_status.ctl is none %}
<div class="no-data-message">
    <h3>No Metrics Data</h3>
    <p>Run the metrics computation to see your training load analysis.</p>
    <pre>python -m scripts.compute_metrics</pre>
    <p class="mt-md">
        <a href="/settings" class="btn btn--primary">Configure Settings</a>
    </p>
</div>
{% else %}

<!-- Current Form Status -->
<div class="form-status-card form-status-card--{{ form_status.status_class }} animate-fade-in">
    <div class="form-status-card__header">
        <div>
            <h3 class="form-status-card__title">{{ form_status.status }}</h3>
            <p class="form-status-card__subtitle">{{ form_status.description }}</p>
        </div>
        <div class="form-status-card__date">
            <span class="text-sm text-muted">as of {{ form_status.date }}</span>
        </div>
    </div>

    <div class="metric-grid">
        <div class="metric-item">
            <div class="metric-item__value metric-item__value--ctl">{{ "%.0f"|format(form_status.ctl) }}</div>
            <div class="metric-item__label">CTL (Fitness)</div>
        </div>
        <div class="metric-item">
            <div class="metric-item__value metric-item__value--atl">{{ "%.0f"|format(form_status.atl) }}</div>
            <div class="metric-item__label">ATL (Fatigue)</div>
        </div>
        <div class="metric-item">
            <div class="metric-item__value metric-item__value--{{ 'negative' if form_status.tsb < 0 else 'positive' }}">
                {{ "%+.0f"|format(form_status.tsb) }}
            </div>
            <div class="metric-item__label">TSB (Form)</div>
        </div>
    </div>
</div>

<!-- This Week Summary -->
<div class="summary-grid stagger-children">
    <div class="summary-stat animate-slide-up">
        <div class="summary-stat__value">{{ fitness_summary.week_tss|int }}</div>
        <div class="summary-stat__label">TSS This Week</div>
    </div>
    <div class="summary-stat animate-slide-up">
        <div class="summary-stat__value">{{ fitness_summary.week_activities }}</div>
        <div class="summary-stat__label">Activities</div>
    </div>
    <div class="summary-stat animate-slide-up">
        <div class="summary-stat__value">{{ streak_info.current }}</div>
        <div class="summary-stat__label">Current Streak</div>
    </div>
    <div class="summary-stat animate-slide-up">
        <div class="summary-stat__value">{{ streak_info.longest }}</div>
        <div class="summary-stat__label">Longest Streak</div>
    </div>
</div>

<!-- Training Load Chart -->
<div class="chart-card animate-slide-up">
    <div class="chart-card__header">
        <h3>Training Load</h3>
        <div class="period-selector" id="chart-days-selector">
            <button class="period-btn" data-days="30">30d</button>
            <button class="period-btn" data-days="60">60d</button>
            <button class="period-btn active" data-days="90">90d</button>
            <button class="period-btn" data-days="180">6mo</button>
            <button class="period-btn" data-days="365">1yr</button>
        </div>
    </div>
    <div class="chart-card__canvas" style="height: 350px;">
        <canvas id="training-load-chart"></canvas>
    </div>
</div>

<div class="dashboard-charts">
    <!-- Weekly Summary -->
    <div class="chart-card animate-slide-up">
        <div class="chart-card__header">
            <h3>Weekly Summary</h3>
        </div>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Week</th>
                        <th>Activities</th>
                        <th>Distance</th>
                        <th>Time</th>
                        <th>TSS</th>
                    </tr>
                </thead>
                <tbody>
                    {% for week in weekly_summary %}
                    <tr>
                        <td><span class="text-muted">{{ week.week }}</span></td>
                        <td>{{ week.activities }}</td>
                        <td><strong>{{ "{:.1f}".format(week.distance_km / 1.609) }}</strong> <span class="text-muted">mi</span></td>
                        <td>{{ week.time_hours }} <span class="text-muted">hr</span></td>
                        <td><strong>{{ week.tss|int }}</strong></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Recent Activities with TSS -->
    <div class="chart-card animate-slide-up">
        <div class="chart-card__header">
            <h3>Recent Activities</h3>
            <a href="/activities" class="view-all-link">View All →</a>
        </div>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Activity</th>
                        <th>Date</th>
                        <th>TSS</th>
                    </tr>
                </thead>
                <tbody>
                    {% for activity in recent_activities %}
                    <tr>
                        <td>
                            <a href="/activities/{{ activity.id }}" class="activity-link">{{ activity.name }}</a>
                            <br><span class="text-xs text-muted">{{ activity.type }}</span>
                        </td>
                        <td><span class="text-muted">{{ activity.date }}</span></td>
                        <td>
                            {% if activity.tss %}
                            <strong>{{ activity.tss|int }}</strong>
                            <span class="tss-badge tss-badge--{{ activity.tss_method }}">{{ activity.tss_method }}</span>
                            {% else %}
                            <span class="text-muted">–</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Profile Info -->
<div class="profile-info">
    <div>
        <strong>Profile:</strong>
        Max HR: {{ profile.max_hr }}{% if not profile.has_user_max_hr %} <span class="text-muted">(estimated)</span>{% endif %} |
        LTHR: {{ profile.lthr }}{% if not profile.has_user_lthr %} <span class="text-muted">(estimated)</span>{% endif %}
    </div>
    <a href="/settings">Edit Settings →</a>
</div>

{% endif %}
{% endblock %}

{% block scripts %}
<script>
let chart = null;

async function loadChart(days) {
    const response = await fetch(`/fitness/api/training-load?days=${days}`);
    const data = await response.json();

    const ctx = document.getElementById('training-load-chart').getContext('2d');

    if (chart) {
        chart.destroy();
    }

    // Use ChartConfig factory for consistent styling
    const config = ChartConfig.trainingLoad(data.labels, {
        ctl: data.ctl,
        atl: data.atl,
        tsb: data.tsb,
        tss: data.tss,
    });

    chart = new Chart(ctx, config);
}

document.addEventListener('DOMContentLoaded', function() {
    // Load initial chart
    loadChart(90);

    // Period selector buttons
    document.querySelectorAll('#chart-days-selector .period-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#chart-days-selector .period-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            loadChart(this.dataset.days);
        });
    });
});
</script>
{% endblock %}
